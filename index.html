<!doctype html>
<html>
  <head>
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"
    ></script>
  </head>
  <body>
    <canvas id="chart"></canvas>

    <div>
      <span id="elevation-gain"></span> up
      <span id="elevation-loss"></span> down
    </div>

    <div>
      <label>
        Smoothing type
        <select id="type" autocomplete="off">
          <option value="none" selected>No smoothing</option>
          <option value="moving-average">Moving average</option>
          <option value="ramer">Ramer</option>
        </select>
      </label>
    </div>

    <div id="moving-average-options" style="display: none">
      <label>
        Max window size (m)
        <input
          type="range"
          value="150"
          id="max-window-size"
          min="1"
          max="2000"
          style="width: 300px"
          autocomplete="off"
        />
      </label>
      <span id="max-window-size-value">150</span>
    </div>

    <script type="module">
      const $movingAverageOptions = document.getElementById(
        "moving-average-options",
      );

      const elevations = [
        12.34, 12.93, 12.92, 12.47, 12.42, 11.03, 10.97, 10.94, 10.91, 10.89,
        10.85, 10.82, 10.75, 10.51, 10.75, 11.24, 11.26, 11.18, 11.15, 11.14,
        11.12, 11.05, 10.97, 10.75, 10.68, 10.67, 10.6, 10.48, 10.43, 10.35,
        10.31, 10.25, 10.22, 10.31, 11.01, 11.31, 11.56, 11.95, 12.03, 12.13,
        12.25, 12.3, 12.33, 12.36, 12.39, 12.43, 12.47, 12.52, 12.53, 12.55,
        12.57, 12.59, 12.61, 12.6, 12.58, 12.57, 12.56, 12.55, 12.56, 12.61,
        12.78, 12.87, 12.89, 12.93, 13.01, 13.16, 13.15, 13.07, 12.92, 12.87,
        12.55, 13.62, 12.49, 12.01, 11.97, 11.94, 11.92, 11.89, 11.87, 11.84,
        11.82, 11.79, 11.77, 11.74, 11.72, 11.7, 11.67, 11.66, 11.58, 11.47,
        11.72, 11.81, 12.54, 13.28, 13.42, 13.57, 13.66, 13.74, 13.8, 13.85,
        13.91, 13.96, 14.03, 14.21, 14.23, 14.23, 14.22, 14.2, 14.2, 14.06,
        13.93, 13.53, 13.5, 13.46, 13.44, 12.44, 12.13, 11.52, 11.34, 11.29,
        11.98, 12.03, 12.16, 12.35, 12.16, 11.94, 11.87, 11.84, 11.81, 11.75,
        10.87, 11.59, 11.92, 11.96, 11.99, 12.04, 12.05, 12.01, 11.98, 11.93,
        10.73, 10.5, 10.03, 9.94, 9.72, 9.7, 9.69, 9.62, 9.6, 9.57, 9.52, 9.06,
        9.01, 8.91, 8.88, 8.44, 8.32, 8.78, 9.14, 10.34, 10.68, 10.88, 11.45,
        10.92, 10.67, 10.35, 10.15, 10.07, 10.01, 9.96, 9.9, 9.87, 9.89, 9.91,
        9.95, 9.98, 10.02, 10.05, 10.09, 10.22, 10.4, 10.48, 10.53, 10.58,
        10.63, 10.7, 10.8, 10.88, 11.02, 11.11, 11.15, 11.26, 11.32, 12.1,
        12.21, 13.44, 13.75, 13.9, 14.21, 14.17, 14.09, 13.95, 13.8, 13.69,
        12.65, 12.34, 12.27, 12.26, 12.25, 12.25, 12.25, 12.24, 12.24, 12.17,
        12.17, 12.15, 12.11, 12.11, 12.1, 12.07, 11.7, 11.54, 11.03, 10.78,
        10.75, 10.74, 10.75, 10.76, 10.78, 10.8, 10.76, 10.28, 10.18, 9.99,
        9.83, 9.49, 9.47, 9.42, 9.47, 9.65, 9.73, 9.98, 10.13, 10.29, 10.57,
        10.83, 10.91, 10.87, 10.81, 10.8, 10.79, 10.68, 10.35, 9.91, 9.79, 9.63,
        9.54, 9.43, 9.26, 9.25, 9.18, 9.12, 9.09, 8.92, 8.87, 8.82, 8.76, 8.67,
        8.64, 8.57, 8.55, 8.97, 8.98, 8.94, 8.7, 8.63, 8.6, 8.55, 8.5, 8.48,
        8.36, 8.32, 8.28, 7.99, 7.04, 6.94, 6.22, 5.78, 5.44, 5.3, 5.28, 5.25,
        5.22, 5.22, 5.27, 5.53, 5.64, 5.86, 5.99, 6.51, 6.59, 6.74, 6.91, 7,
        7.08, 7.14, 7.22, 7.36, 7.43, 7.52, 7.54, 7.65, 7.7, 7.82, 7.92, 8.03,
        8.09, 8.15, 8.22, 8.36, 8.49, 8.58, 8.58, 8.58, 8.58, 8.58, 8.57, 8.54,
        8.42, 8.36, 8.3, 8.28, 8.25, 8.19, 8.01, 7.97, 7.95, 7.91, 7.87, 7.79,
        7.78, 7.78, 7.8, 7.81, 7.86, 7.87, 7.89, 7.92, 7.97, 8.01, 8.04, 8.05,
        8.1, 8.12, 8.24, 8.33, 8.37, 8.39, 8.41, 8.43, 8.44, 8.45, 8.49, 8.58,
        8.62, 8.65, 8.83, 9.03, 8.89, 8.86, 8.76, 8.67, 8.04, 7.65, 7.51, 7.43,
        7.25, 7.12, 5.98, 5.65, 5.55, 5.27, 5.26, 5.15, 5.14, 5.14, 5.14, 5.25,
        5.37, 5.41, 5.45, 5.66, 6.2, 6.2, 6.19, 5.96, 5.91, 5.79, 5.51, 5.42,
        5.34, 5.32, 6.01, 7.65, 7.93, 7.96, 7.9, 7.81, 7.59, 7.21, 4.49, 4.78,
        4.88, 6.64, 6.96, 7.16, 7.88, 8.39, 8.42, 8.42, 8.43, 8.24, 8.59, 8.35,
        8.38, 8.38, 8.33, 8.3, 8.26, 7.76, 7.41, 7.38, 7.48, 8.5, 8.62, 9.45,
        10.47, 10.63, 10.14, 10.07, 9.72, 9.92, 10.28, 10.8, 10.87, 11.18,
        11.13, 10.3, 10.2, 9.91, 9.63, 9.28, 9.32, 9.61, 9.66, 9.65, 9.25, 7.83,
        7.7, 7.48, 7.28, 6.7, 6.69, 5.73, 5.51, 5.43, 5.31, 5.22, 5.14, 5.07, 5,
        4.93, 4.88, 4.84, 4.8, 4.76, 4.53, 4.5, 4.5, 4.5, 4.52, 4.53, 4.56,
        4.58, 4.65, 4.75, 4.77, 4.79, 4.82, 4.84, 4.85, 4.87, 5.06, 5.14, 5.22,
        5.29, 5.37, 5.44, 5.49, 5.62, 5.93, 6.15, 6.26, 6.32, 6.57, 6.73, 6.84,
        6.87, 6.88, 6.9, 6.92, 6.93, 6.93, 6.91, 6.76, 6.74, 6.7, 6.55, 6.23,
        6.22, 6.05, 4.77, 4.63, 4.59, 4.9, 5.1, 5.3, 5.63, 5.64, 5.39, 5.1,
        4.81, 4.68, 4.5, 4.37, 4.34, 4.21, 3.7, 3.49, 3.41, 3.2, 3.16, 3.49,
        4.76, 5.32, 5.73, 5.99, 6.12, 6.32, 6.42, 6.49, 6.49, 6.45, 6.43, 6.4,
        6.37, 6.35, 6.27, 6.25, 6.24, 6.22, 6.2, 6.12, 6.01, 5.98, 5.96, 5.93,
        5.91, 5.9, 5.89, 5.9, 5.91, 5.92, 5.93, 5.93, 5.94, 5.95, 5.95, 5.96,
        5.97, 5.98, 6, 6.02, 6.06, 6.26, 6.43, 6.66, 6.75, 6.87, 6.96, 7.02,
        7.05, 7.07, 7.14, 7.44, 7.72, 7.8, 7.86, 7.96, 8.21, 8.43, 8.49, 8.59,
        8.63, 8.62, 8.56, 8.53, 8.5, 8.48, 8.44, 8.39, 8.32, 8.16, 7.95, 7.83,
        7.71, 7.61, 7.24, 7.22, 6.95, 6.59, 6.27, 6, 5.81, 5.58, 5.43, 5.31,
        5.2, 5.14, 5.1, 5.08, 5.06, 5.05, 5.04, 5.01, 4.99, 4.99, 5, 5.04, 5.24,
        5.35, 5.41, 5.47, 5.58, 5.69, 5.87, 5.99, 6.04, 6.1, 6.21, 6.32, 6.43,
        6.48, 6.55, 6.68, 6.71, 6.73, 6.78, 6.84, 6.86, 6.87, 6.86, 6.84, 6.76,
        6.69, 6.71, 6.76, 6.84, 6.91, 6.98, 7.03, 7.04, 7.05, 7.05, 7.06, 7.08,
        7.1, 7.13, 7.17, 7.24, 7.25, 7.27, 7.27, 7.26, 7.25, 7.23, 7.21, 7.12,
        7.06, 7, 6.97, 6.97, 6.99, 7, 7.04, 7.21, 7.34, 7.56, 7.65, 7.84, 7.9,
        7.98, 8.14, 8.71, 8.75, 8.78, 8.81, 8.82, 8.84, 8.87, 9.02, 9.09, 9.72,
        10.37, 10.56, 10.66, 22.12, 22.56, 23.7, 23.74, 23.76, 23.77, 23.77,
        23.74, 22.42, 21.74, 21.21, 20.17, 18.1, 16.79, 16.71, 16.39, 16.47,
        17.31, 17.43, 18.09, 19.63, 19.89, 20.69, 20.98, 21.05, 21.15, 21.22,
        21.09, 20.9, 20.45, 20.1, 19.74, 19.64, 19.16, 18.56, 18.65, 18.75,
        18.84, 18.9, 18.94, 19.16, 19.26, 19.28, 19.3, 19.31, 19.3, 19.3, 19.29,
        19.2, 19.02, 18.89, 18.87, 18.83, 18.71, 18.6, 18.45, 18.26, 18.18,
        18.14, 18.16, 18.23, 18.29, 18.32, 18.33, 18.35, 18.36, 18.36, 17.91,
        17.83, 17.21, 16.76, 16.44, 15.63, 15.38, 15.28, 15.04, 14.69, 14.65,
        13.49, 13.47, 13.29, 13.27, 13.19, 13.14, 13.09, 13.07, 13.06, 13.02,
        13.01, 13.01, 13, 13, 12.85, 12.59, 12.53, 12.4, 12.35, 12.28, 12.23,
        12.18, 12.15, 12.68, 13.54, 13.98, 14.62, 14.88, 15.34, 15.87, 16.05,
        16.21, 15.53, 15.19, 14.8, 14.3, 14.05, 13.66, 13.36, 13.32, 13.31,
        13.3, 13.32, 13.35, 13.37, 13.4, 13.58, 13.71, 13.75, 13.8, 13.93,
        15.41, 15.43, 15.49, 15.56, 15.6, 15.73, 15.91, 15.95, 16.24, 16.71,
        16.77, 16.78, 17.21, 17.44, 18.04, 18.67, 18.94, 19.27, 20.08, 20.34,
        20.42, 20.52, 21.01, 21.25, 21.45, 21.59, 21.71, 22.18, 22.56, 24.96,
        26.4, 27.65, 28.34, 28.46, 28.1, 27.91, 27.75, 27.67, 27.57, 27.43,
        27.22, 26.53, 25.27, 24.49, 23.48, 20.53, 19.25, 18.88, 18.72, 18.69,
        18.67, 18.64, 18.62, 18.6, 18.59, 18.57, 18.56, 18.54, 18.53, 18.52,
        18.5, 18.49, 18.48, 18.42, 18.8, 19.33, 19.89, 20.74, 20.72, 20.7,
        20.24, 20.51, 20.63, 21.01, 21.04, 21.09, 21.11, 21.31, 21.52, 21.57,
        21.6, 21.65, 21.68, 21.7, 21.71, 21.76, 21.76, 21.77, 21.77, 21.76,
        21.72, 21.67, 21.64, 21.62, 21.62, 21.61, 21.6, 21.59, 21.58, 21.55,
        21.53, 21.45, 21.33, 21.33, 21.11, 20.78, 20.49, 20.42, 20.32, 20.18,
        20.08, 19.92, 19.9, 19.9, 19.9, 19.9, 19.95, 19.97, 20.02, 20.07, 21.19,
        21.33, 21.41, 21.49, 21.52, 21.98, 22, 22.02, 22.05, 22.07, 22.13,
        22.18, 22.25, 22.28, 22.38, 22.48, 22.56, 22.73, 23.01, 23.17, 23.27,
        23.4, 24.79, 25.54, 25.77, 26.13, 26.37, 26.56, 26.62, 27.06, 27.68,
        27.9, 28.11, 28.28, 28.47, 28.88, 29.06, 29.46, 29.89, 30.02, 30.15,
        30.81, 31.2, 31.33, 31.46, 31.79, 32.01, 32.13, 32.2, 32.41, 32.45,
        32.39, 32.2, 31.73, 31.57, 31.32, 30.95, 30.92, 30.86, 30.79, 30.56,
        30.45, 30.35, 30.3, 30.25, 30.18, 30.18, 30.53, 30.94, 31.36, 32.94,
        33.31, 34.24, 34.37, 34.45, 34.49, 34.68, 34.88, 35.15, 35.22, 35.3,
        35.43, 35.96, 36.66, 37.08, 37.37, 37.98, 39.18, 39.97, 40.12, 40.19,
        40.27, 40.34, 40.42, 40.6, 41, 41.15, 41.42, 41.48, 41.59, 41.74, 41.94,
        44.39, 45.2, 46.55, 47.64, 48.72, 49.08, 49.48, 49.64, 49.71, 49.75,
        49.88, 49.94, 50.43, 51.01, 51.47, 52.44, 53.01, 54.71, 55.2, 56.1,
        56.89, 57.53, 58.62, 61.13, 61.45, 61.85, 65.55, 65.93, 63.97, 61.25,
        60.01, 59.57, 59.52, 59.52, 59.81, 60.58, 60.95, 61.27, 63.17, 63.55,
        65.35, 66.17, 66.71, 67.08, 67.54, 68.24, 69.3, 70.52, 71.73, 73.02,
        74.53, 78.31, 78.69, 78.63, 78.6, 78.52, 78.43, 78.29, 78.15, 73.76,
        72.93, 71.83, 81.65, 81.85, 82.61, 83.7, 84.18, 85.04, 86.09, 87.11,
        88.07, 89.08, 89.17, 89.36, 89.49, 89.57, 89.6, 89.56, 88.37, 86.7,
        86.18, 85.62, 85.18, 85.16, 85.16, 85.29, 85.38, 85.25, 84.39, 83.97,
        83.98, 84.06, 84.38, 84.75, 85.33, 85.49, 86.27, 87.95, 88.66, 88.79,
        88.99, 88.13, 88.39, 90.43, 91.03, 91.42, 91.74, 91.8, 91.81, 91.78,
        91.82, 92.61, 92.64, 94.15, 94.2, 94.24, 93.63, 93.5, 93.41, 93.26,
        93.06, 92.79, 92.5, 92.39, 90.78, 89.59, 89.37, 89.12, 89.21, 90.86,
        91.36, 91.23, 89.65, 88.4, 87.66, 87.28, 87, 86.87, 86.56, 86.39, 86.26,
        86.23, 86.18, 85.88, 85.78, 85.63, 84.24, 82.45, 81.4, 80.64, 80.04,
        80.02, 80.06, 80.11, 80.56, 80.83, 81.49, 82.34, 86.27, 87.01, 87.18,
        87.44, 87.55, 88.38, 89.86, 89.98, 91.19, 92.61, 92.75, 93.07, 93.43,
        93.57, 93.89, 94.25, 94.33, 94.56, 94.88, 95.36, 95.36, 95.32, 95.28,
        95.2, 93.59, 91.89, 91.73, 91.27, 90.98, 89.94, 89.72, 89.48, 88.97,
        88.4, 88.25, 87.98, 87.72, 87.28, 86.67, 86.21, 85.98, 85.62, 85.16,
        84.87, 84.75, 82.88, 81.96, 81.92, 81.79, 81.26, 80.69, 80.26, 80.08,
        79.21, 79.12, 78.74, 64.98, 62.72, 61.28, 61.08, 60.97, 60.7, 60.7,
        60.68, 60.62, 60.55, 60.34, 58.86, 58.12, 57.76, 57.41, 56.89, 54.58,
        54.29, 54.24, 54.23, 54.27, 54.51, 54.79, 54.94, 56.98, 57.51, 57.62,
        57.64, 57.62, 57.61, 57.59, 57.51, 57.47, 57.42, 57.38, 57.35, 57.28,
        57.18, 57.14, 57.1, 57.18, 57.68, 57.82, 57.71, 57.68, 57.66, 57.68,
        57.74, 57.88, 58.22, 58.64, 58.88, 59.04, 59.24, 59.34, 60.79, 64.89,
        65.84, 66.19, 66.87, 69.58, 71.82, 72.48, 72.72, 72.81, 72.82, 72.68,
        72.64, 72.65, 72.79, 73.05, 73.31, 73.92, 74.47, 74.98, 75.42, 75.98,
        78.61, 78.97, 79.14, 79.21, 79.43, 79.8, 79.98, 83.49, 85.28, 87.74,
        87.94, 88.32, 88.65, 90.83, 90.57, 90.25, 89.89, 89.39, 88.98, 88.45,
        87.56, 87.4, 87.44, 87.67, 87.77, 88.13, 88.48, 88.26, 88.24, 88.33,
        88.57, 88.9, 89.12, 89.34, 88.61, 84.72, 84.57, 83.34, 81.41, 80.95,
        80.1, 79.84, 79.6, 79.05, 78.67, 78.62, 78.58, 78.11, 78, 77.61, 77.33,
        77.05, 76.93, 76.87, 76.85, 76.5, 76.45, 76.4, 73.95, 73.81, 73.9,
        74.14, 74.36, 74.51, 74.71, 76.36, 76.97, 77.38, 77.47, 77.59, 77.79,
        77.96, 78.09, 78.45, 80.08, 83.51, 88.19, 88.67, 89.36, 91.14, 91.41,
        91.49, 91.5, 91.33, 89.62, 89.24, 88.94, 88.71, 88.48, 88.03, 87.65,
        87.34, 87.3, 87.27, 87.08, 86.31, 86.28, 86.24, 86.2, 86, 85.61, 85.52,
        85.11, 84.96, 84.86, 84.66, 84.62, 84.57, 84.51, 84.45, 84.4, 84.29,
        83.96, 83.94, 83.92, 83.71, 83.41, 83.25, 83.25, 83.15, 83.02, 83,
        82.75, 82.71, 82.67, 82.24, 81.93, 81.77, 81.58, 81.45, 81.05, 80.61,
        80.49, 80.07, 78.9, 78.67, 78.39, 77.04, 72.59, 72, 70.63, 67.69, 68.67,
        68.81, 68.97, 69.34, 69.62, 69.2, 68.14, 67.4, 67.3, 67.73, 70.48,
        70.69, 70.54, 70.53, 70.49, 70.46, 70.45, 70.4, 70.38, 70.36, 70.29,
        70.25, 70.23, 70.16, 70.09, 70.01, 69.93, 69.85, 69.84, 69.84, 68.64,
        68.58, 68.54, 68.48, 68.15, 67.41, 67.32, 67.2, 67.01, 66.95, 65.24,
        64.67, 65.56, 67.32, 68.15, 68.7, 68.75, 71.89, 72.12, 72.16, 72.29,
        72.54, 72.62, 72.7, 72.74, 72.81, 72.88, 72.92, 72.95, 73.11, 73.18,
        73.52, 74.05, 77.75, 78.6, 82, 87.36, 91.07, 95.12, 100.36, 101.81,
        107.27, 110.04, 110.93, 112, 111.82, 113.92, 115.82, 116.49, 116.59,
        116.62, 116.64, 116.2, 115.83, 115.52, 115.44, 115.42, 115.41, 115.36,
        115.24, 115.17, 115.11, 115.04, 114.93, 114.79, 114.76, 114.72, 114.68,
        114.65, 114.62, 114.59, 114.55, 114.51, 114.52, 114.66, 114.64, 114.1,
        110.24, 110.02, 109.94, 109.92, 109.87, 107.66, 109.78, 110, 110.37,
        110.44, 110.5, 110.59, 110.64, 110.73, 110.85, 110.87, 110.95, 111.02,
        111.22, 114.78, 114.55, 113.48, 109.92, 108.24, 110.64, 110.15, 109.83,
        109.45, 109.49, 109.64, 110.03, 110.45, 110.95, 112.5, 113.43, 114.14,
        115.11, 115.99, 113.39,
      ];
      const distances = [
        79.1, 39.3, 57.9, 4.2, 82.6, 5.1, 3.6, 2.6, 2.8, 4.5, 4, 12.5, 74.6,
        75.2, 74.3, 76.6, 14.9, 5.3, 2.2, 4.5, 19.5, 14.4, 33.2, 10.5, 0.8, 8.6,
        17, 9.4, 16.7, 9.4, 13.4, 9.2, 28.3, 55.4, 25, 22.4, 41.4, 13.9, 14.1,
        16.9, 6.6, 4.1, 4.8, 3.7, 6.4, 6.6, 8.6, 1.7, 2.6, 4.3, 4.1, 13.5, 17.5,
        7.1, 3, 2.5, 21.4, 9, 10.8, 28.6, 27.2, 10.7, 10.1, 12.2, 42.6, 2.4,
        9.3, 11.3, 3.6, 86.8, 95.9, 80.3, 30.1, 3.2, 2.4, 2, 2.3, 2.1, 2.3, 2.2,
        2.5, 2.6, 2.6, 2.5, 2.5, 3.5, 2.3, 13.2, 87.7, 67.8, 80.6, 88.2, 33.7,
        7.2, 8.4, 5.2, 5.2, 5, 3.7, 3.5, 3.7, 4.7, 20.9, 5.1, 3.3, 3.9, 7.5,
        1.4, 16.8, 15.3, 40.9, 6.8, 17.9, 6.5, 76.5, 18.7, 41.4, 18.1, 34.4,
        67.1, 4.2, 10.9, 19.5, 63.2, 17.8, 4.8, 2.2, 2.3, 3.8, 70.9, 98.1, 24.9,
        5.5, 3.9, 12, 9.6, 11.2, 6, 7.1, 70.8, 11.9, 31.7, 6.9, 19.8, 1.3, 1.6,
        6.9, 1.4, 3, 4.6, 38.1, 4.7, 9.7, 2.8, 43.6, 18.4, 55.9, 14.4, 44.8,
        14.1, 9.4, 42.3, 55.2, 11.6, 14, 10.6, 4.3, 4.6, 3.9, 6.4, 15.3, 7.4,
        3.9, 5.4, 4.2, 5, 3, 3.8, 11.9, 13.8, 6.1, 4, 5.2, 5.7, 7.2, 8.9, 7.6,
        12, 8.2, 4.3, 14.9, 8.5, 55.2, 4.2, 39.8, 15.2, 8.6, 35.8, 11.6, 8.4,
        7.9, 7, 4.5, 41.8, 23.5, 15.5, 4.4, 2.1, 0.4, 1, 1.3, 1, 20.8, 2.2, 3.9,
        17.9, 5.1, 5.5, 7.4, 44.9, 15.4, 35.1, 30.4, 10.2, 8.6, 7.4, 5.6, 7.5,
        7.4, 11.6, 30.8, 5.1, 10.8, 10.1, 25.6, 3.1, 24.1, 11.6, 19.1, 5.4, 14,
        8, 8.4, 16.1, 20.7, 23.3, 6, 9.2, 1.6, 0.7, 10, 17.6, 15.8, 4.4, 6.1, 4,
        4.8, 8.3, 0.9, 3.9, 3.6, 2.1, 13.1, 4.2, 4.5, 5.6, 8.7, 3.7, 9.1, 4.2,
        137.4, 4.7, 12.1, 22.6, 4.4, 2.1, 2.6, 3, 1.2, 6.8, 1.8, 2.2, 14.1,
        36.1, 3.5, 24.6, 17.6, 19.9, 13.1, 2.4, 6, 6.4, 4, 15.7, 18.4, 6.1,
        12.7, 8.9, 27.4, 4.2, 7.1, 7.9, 3.4, 3.5, 2, 3.2, 4.9, 2.3, 2.9, 0.6,
        3.4, 1.7, 3.9, 3.2, 4.2, 2.2, 2.4, 2.6, 7.2, 8.1, 17.7, 5.4, 4, 4.6,
        7.3, 9.9, 8.9, 37.4, 9.4, 6.5, 2.2, 2.9, 5.5, 29.3, 18.7, 4.6, 7.2, 5.2,
        15.5, 5.3, 9.6, 9.5, 8.6, 11.9, 1.6, 3.1, 3.4, 5.1, 2.8, 2.1, 1.3, 3.3,
        2, 10.1, 8.8, 5.1, 2.6, 2.8, 2.6, 1.4, 1.4, 4.1, 8, 3, 3.1, 15.2, 48.2,
        22.7, 2, 5.6, 4.5, 29.8, 17.2, 6.8, 4.3, 10, 7.8, 70.5, 44.2, 30.5,
        82.8, 63, 56.5, 6.9, 16.3, 1.7, 25.3, 12.7, 3.6, 3.4, 16.3, 64.8, 11.6,
        5.1, 43.2, 3.7, 9.2, 19, 6.8, 6.7, 117.5, 24.5, 59.3, 21.2, 6.2, 15.9,
        7.8, 12, 13.7, 127.1, 20.1, 4.4, 49.4, 7.3, 4.7, 21.2, 37.4, 26.1, 40.8,
        14.9, 61.7, 56.5, 41.7, 40.1, 34.9, 31.3, 45.5, 14.1, 58.6, 45.7, 13.3,
        33, 70.7, 5.9, 40.2, 54.1, 59.3, 54.1, 4.5, 40.1, 25, 19.4, 38.2, 7.4,
        35.4, 30.1, 47.7, 4.5, 15, 18, 30.1, 47.5, 34.8, 24.3, 16.9, 41.8, 41.9,
        3.4, 5.6, 5.3, 17.1, 0.3, 34.4, 9.6, 3.7, 5.6, 4, 3.9, 3.7, 3.5, 4, 3.4,
        3.2, 3.1, 4, 30.1, 18.2, 3.5, 3.9, 4.3, 3.7, 4.8, 3.5, 10.6, 18.3, 3.8,
        4.5, 8, 3.6, 3, 3.1, 18.6, 5.5, 6, 4.3, 4.8, 3.7, 2.9, 7.1, 18.1, 18.8,
        23.4, 21.5, 48.5, 24.8, 20, 5.8, 4.9, 6.4, 9.6, 14.3, 2.2, 7.7, 23.3,
        3.3, 10, 51.9, 45.9, 1.9, 20.9, 72.1, 12.6, 8.6, 43.1, 16, 12.8, 31.1,
        23.9, 26.2, 18.8, 20.3, 14.9, 22.8, 30.3, 16.7, 62.7, 32.5, 13.1, 5.5,
        17.1, 35.8, 29.6, 60, 19.7, 19.1, 20.5, 23.4, 31.9, 11.5, 9.8, 20.2,
        8.6, 6, 6, 6.6, 4.1, 12.8, 2.9, 2, 1.7, 2.3, 9.6, 12.8, 3.3, 2.9, 3.2,
        3.4, 3.8, 10.9, 2.1, 4.4, 1.5, 1.7, 1.6, 0.9, 2, 0.9, 2, 0.4, 1.9, 2.7,
        2.4, 3.3, 14.9, 12, 17.6, 6.6, 7.3, 4.9, 3.4, 1.4, 1.3, 3.3, 14.1, 11.8,
        3.1, 2.5, 3.6, 10.1, 11, 3.8, 7.2, 9, 8.3, 14.2, 5.7, 4, 3.8, 4.5, 4.6,
        5.5, 10.9, 12.1, 7.4, 7, 5.9, 17.5, 0.7, 10.1, 12.1, 10.5, 9.8, 7.7,
        9.8, 7.7, 7.5, 9.7, 8, 6.7, 4.8, 6.8, 2.4, 3.8, 7.8, 8.8, 8.8, 6.4, 8.1,
        21.9, 7.8, 3.6, 3, 6, 5.9, 9.6, 7.3, 3.5, 3.6, 7.7, 7.1, 7.8, 3.5, 4.8,
        10.7, 3.5, 2.6, 5.2, 10.2, 8.3, 2.4, 2.9, 10.3, 16.7, 19.6, 18.8, 11.4,
        13.4, 10.8, 13.3, 14.8, 4.1, 4.7, 4.9, 5.3, 6.3, 4.9, 7, 7.4, 13.3, 3.4,
        13.2, 4.1, 4.1, 3, 3.5, 3.1, 15.7, 10, 10.5, 9.3, 10.3, 7.2, 2, 7.7, 24,
        15.1, 21.3, 7.8, 13.7, 3.5, 4.4, 8, 33.1, 2.2, 2.4, 1.9, 1.1, 1.4, 3.1,
        15.2, 8.4, 109, 35.6, 7.3, 3.7, 285.5, 10.9, 48.9, 4.6, 3.7, 2.8, 6.4,
        6.5, 65.4, 29.9, 26, 43.8, 48.7, 44.9, 4.4, 60.9, 5.7, 58.8, 10.2, 38.8,
        65.7, 10.1, 42, 27.8, 10.1, 15.7, 41.8, 19.8, 19.4, 35.4, 21.5, 34,
        18.2, 60, 70.4, 28.9, 12.3, 8.1, 5.3, 3.5, 16.6, 11.9, 3.2, 5.6, 12,
        7.3, 2.1, 5.7, 17.6, 16.9, 8.9, 1.5, 2.6, 8.1, 7.1, 10.4, 16, 9.3, 18.7,
        5, 10.4, 7.2, 4, 3.5, 4.6, 5.2, 2.8, 47.6, 4.4, 32.2, 20.2, 12.9, 31.1,
        11, 4.7, 12.3, 23.3, 2.4, 80.3, 3.6, 54.2, 3.4, 15.2, 8.7, 9.9, 3.3,
        4.3, 11.3, 7.2, 6.3, 3.6, 3.6, 23.2, 25.1, 6.8, 16.7, 7.1, 19.2, 23.4,
        15.3, 10.7, 57.1, 28.9, 14.1, 22.5, 9.4, 17.2, 21.7, 8, 14.5, 54.7,
        22.1, 21, 25.2, 12.5, 34.6, 56.4, 9.3, 4, 6.9, 13.8, 9.7, 6.5, 6.9,
        29.5, 12.7, 3, 4.3, 8.9, 82.1, 1.4, 3.1, 4.3, 2.8, 7.6, 11.5, 3, 19.4,
        48, 18.6, 14.4, 59.9, 19.6, 41.6, 38.3, 19.1, 18.7, 35.2, 11.6, 4.2, 5,
        31.2, 21, 20.7, 34.9, 21.4, 25.2, 12.2, 54.6, 36.9, 47, 74.1, 81, 16.3,
        6.4, 4.7, 2.2, 2.8, 3.4, 5.2, 15.1, 24.3, 14, 17.6, 58.9, 39.6, 16.9,
        9.6, 1.9, 2, 2, 1.9, 1.5, 1.5, 1.5, 1.5, 1.4, 1.5, 1.4, 1.6, 1.5, 1.5,
        11.9, 53.1, 28.6, 31.5, 103.7, 7.3, 5.1, 109.3, 81.6, 78.1, 50.2, 2.9,
        4.1, 1.9, 15.5, 16.8, 4.3, 3.2, 5.8, 3.3, 3.1, 1.8, 13.9, 1.9, 5.7, 3.4,
        7, 11.6, 10, 5.5, 3.4, 1, 1, 3, 4.6, 3.8, 15.4, 11.1, 19.9, 48.7, 21.7,
        45.9, 62.9, 32, 6.8, 7.8, 13.1, 10.4, 51.2, 8.3, 5.8, 5.5, 3.5, 14.7,
        3.4, 6.5, 5.2, 87.2, 11.5, 5.9, 5.5, 2.3, 70, 4.2, 6.5, 5.4, 3.4, 7.9,
        5.2, 5.6, 2.7, 7.7, 6.2, 4.9, 8.2, 11.1, 5.2, 3.4, 3.9, 37.6, 16.2, 4.9,
        7.4, 4.9, 4, 1.3, 9.6, 14.4, 5.4, 5.5, 4.4, 5.1, 12.6, 6.4, 14.5, 13.9,
        4.4, 5.2, 27.7, 17.4, 5.6, 6, 17.2, 13.3, 9.4, 5.1, 28.1, 37.3, 18.3,
        25.9, 32.2, 8.9, 11.5, 17.6, 1.3, 2.9, 4, 14.1, 8.8, 9.9, 6.2, 6.2,
        13.5, 12.2, 31.7, 17.8, 13.7, 60.3, 20.8, 64.9, 7.7, 4.6, 2.4, 9.8, 9.7,
        12.4, 3, 3.8, 5.3, 18.9, 20.7, 11.2, 8.2, 17.7, 40.6, 30.2, 6.8, 3.2,
        4.1, 3.5, 5, 12.6, 67.2, 15.9, 16.4, 2.5, 4.4, 5, 5.7, 54.8, 15.3, 23.7,
        21.2, 24.1, 10.3, 13.2, 5.7, 2.9, 1.9, 5.3, 3, 23.3, 31.9, 22.2, 42.2,
        23.9, 66, 28.2, 40.2, 28.9, 20.8, 28, 96.5, 50.2, 40.9, 114, 21.7, 94.1,
        51.3, 32.1, 24.1, 6.6, 12.2, 33, 35.5, 16.4, 15, 62, 9.3, 49.4, 30.3,
        27.9, 26.2, 26.3, 23.4, 30.3, 36.4, 38.7, 41.1, 39.4, 91.3, 45.7, 7.8,
        2.2, 6, 5.6, 6.6, 5.9, 190.6, 41, 80.8, 284.4, 5.3, 19.9, 26.3, 10.5,
        17.1, 22, 21.4, 21.9, 28.1, 3.5, 7.6, 6.4, 5, 2.2, 38.7, 56.8, 46.9,
        16.6, 26.7, 41.5, 2.8, 8.2, 25, 12.2, 50.6, 39.3, 27.2, 38.5, 11.6,
        31.4, 24.5, 34.6, 23.6, 65.1, 75.5, 32, 7.7, 57.7, 77.5, 131.8, 116.6,
        30.4, 29.6, 26.9, 9.6, 12.9, 19.4, 43.6, 67.4, 1.8, 143.5, 10, 54.6,
        47.6, 7.8, 5.6, 8.5, 10.5, 13.3, 12.4, 4, 58.9, 59.1, 12.1, 72.7, 7.5,
        90.4, 49.1, 52.3, 78.1, 49.1, 26.9, 13.9, 11.4, 6.1, 21.6, 37.8, 19.4,
        2.9, 4.9, 27.8, 8.1, 11.6, 60, 53.9, 36.5, 30.6, 44.3, 14, 9.5, 7.7,
        31.3, 10.4, 21, 22.2, 112.7, 40.1, 11.2, 23.3, 10.2, 47.8, 77.2, 5.5,
        44.1, 46.2, 4.9, 11.8, 15.5, 7.4, 22.8, 67.8, 15.1, 26.1, 26.1, 55.4,
        14, 10, 6.6, 8.5, 68.6, 67.5, 8.7, 32.4, 48.7, 80.5, 10.6, 10.4, 21.8,
        25.6, 6.8, 11.1, 9.9, 16, 24.5, 20.8, 10.4, 15.3, 17.6, 9.7, 3.9, 60.5,
        25.7, 1.2, 3.4, 15.1, 17.2, 13.9, 6.6, 55.9, 60.8, 29.1, 254.9, 57,
        80.9, 11.6, 7.6, 45.7, 10.4, 5.8, 7.8, 7.4, 41.4, 81.4, 18.3, 9, 8.9,
        13.2, 68.5, 21.6, 10.1, 8.1, 10.2, 21.6, 14.7, 6.7, 73, 32.6, 21.2,
        13.8, 8.8, 5.3, 5.2, 15.7, 7.8, 6.4, 6.5, 5.6, 11.1, 15.8, 7.4, 8.1,
        57.2, 76.2, 59.1, 65.6, 14.1, 11.4, 14.4, 11.6, 17.2, 28.3, 46, 34.2,
        32, 37.4, 12.7, 87.4, 115, 22.3, 8.4, 16.3, 67.1, 78.9, 36.1, 24.7,
        26.9, 20.5, 57.2, 27.5, 11.9, 20.2, 15.4, 12.7, 26.9, 24.5, 24.4, 24.9,
        85.3, 129, 23.6, 17.7, 7.6, 21.2, 31.6, 19.4, 134, 73.6, 85.6, 7.1,
        13.4, 12.5, 209.3, 17.5, 17.4, 15.8, 19.5, 14.7, 21.1, 56, 43.4, 22.6,
        32.1, 9.6, 31, 59.2, 76.7, 11.4, 36.1, 36.1, 29.8, 19.6, 23.6, 68.1,
        91.6, 3.1, 26.7, 49.3, 15.3, 38.3, 16, 15, 32.2, 22.1, 3.2, 3.4, 27.5,
        6.1, 22.3, 17.1, 20.6, 14.1, 11.2, 7.3, 80.3, 3.9, 3.9, 116.8, 23.2,
        17.8, 16.4, 9.7, 6.4, 7.6, 58.8, 26, 21.2, 5.4, 8, 14.9, 12.6, 8.7,
        21.5, 64.9, 103.6, 96, 9.5, 15, 53, 17.9, 12, 4.2, 27.2, 71.3, 15.8,
        12.9, 10.5, 9.9, 17.9, 17.7, 21.9, 3.3, 3.1, 23.9, 79.1, 4.2, 4.8, 4,
        21.4, 33.5, 7.2, 32, 12.2, 8.1, 16.9, 5.5, 6.5, 7.3, 5.7, 4.6, 8.6,
        24.8, 1.3, 1.3, 16.9, 27.4, 26.1, 8.3, 22.7, 16.6, 2.8, 24.3, 3.2, 2.3,
        19.3, 11.5, 6.6, 9, 6.3, 16.6, 19.7, 6.2, 114.9, 64.7, 7.2, 8.3, 38.2,
        133, 28.7, 73.1, 146.7, 64.8, 6.2, 6.7, 19.4, 34.3, 48.7, 53, 52.6,
        28.6, 50, 153.6, 45.6, 30, 1.1, 5, 3.5, 0.9, 5, 1.7, 2.1, 6, 3.9, 1.6,
        5.4, 5.3, 5.3, 5.9, 5, 0.9, 0.1, 117.5, 7.9, 6.1, 7.2, 29.2, 49.8, 4.3,
        5.7, 7.9, 2.2, 81.4, 62.7, 218.8, 101.5, 42.6, 29.5, 3, 179.9, 20.6,
        3.9, 11.4, 22.8, 7.6, 8.1, 5.2, 7.5, 7.8, 4.3, 3.2, 15.8, 6.2, 22.9,
        33.3, 192.3, 59.4, 108.8, 119.4, 117.8, 123.5, 148.2, 39, 112, 53.7,
        21.4, 66.3, 80.6, 79.3, 54, 46.7, 14, 8.1, 8.1, 70.3, 46.5, 38.6, 41.9,
        6.6, 6.1, 15.1, 20.5, 13.1, 13.7, 14.4, 15.9, 13.9, 3.1, 3.3, 4.6, 3.5,
        4.4, 5.4, 9.4, 14.5, 15.3, 42.8, 42.8, 45.2, 175.6, 18.5, 7.9, 2.1, 7,
        510.1, 402.5, 18.4, 46.4, 6.2, 5.1, 7.5, 4.4, 7.7, 10.4, 1.6, 8.3, 7.5,
        23.6, 233.9, 19.4, 44.5, 100.7, 122.6, 103.2, 79.8, 14.4, 22.3, 18.7,
        8.9, 13.6, 9.6, 9.6, 28.8, 23.1, 8.5, 10.6, 19.8, 33.9,
      ];

      const chart = new Chart(document.getElementById("chart"), {
        type: "scatter",
        data: {
          datasets: [
            {
              data: [],
              showLine: true,
              pointStyle: false,
            },
          ],
        },
        options: {
          scales: {
            y: {
              title: {
                text: "Elevation (m)",
                display: true,
              },
            },
            x: {
              title: {
                text: "Distance (m)",
                display: true,
              },
            },
          },
          plugins: {
            legend: {
              display: false,
            },
          },
        },
      });

      setData(elevations, distances);

      const $maxWindowSize = document.getElementById("max-window-size");

      $maxWindowSize.addEventListener("input", (e) => {
        setData(
          movingAverage(elevations, distances, Number(e.target.value)),
          distances,
        );
        document.getElementById("max-window-size-value").innerText =
          e.target.value;
      });

      document.getElementById("type").addEventListener("change", (e) => {
        switch (e.target.value) {
          case "none":
            setData(elevations, distances);
            $movingAverageOptions.style.display = "none";
            break;
          case "moving-average":
            setData(
              movingAverage(
                elevations,
                distances,
                Number($maxWindowSize.value),
              ),
              distances,
            );
            $movingAverageOptions.style.display = "block";
            break;
          case "ramer":
            setData(ramer(elevations, distances, 5), distances);
            $movingAverageOptions.style.display = "none";
            break;
        }
      });

      function setData(elevations, distances) {
        let runningDistance = 0;

        chart.data.datasets[0].data = elevations.map((elevation, i) => ({
          x: i === 0 ? 0 : (runningDistance += distances[i - 1]),
          y: elevation,
        }));

        chart.update("none");

        const { gain, loss } = elevations.reduce(
          (totals, current, i) => {
            const next = elevations[i + 1];
            if (next === undefined) {
              return totals;
            }

            if (current > next) {
              return {
                ...totals,
                loss: totals.loss + current - next,
              };
            }

            return {
              ...totals,
              gain: totals.gain + next - current,
            };
          },
          { gain: 0, loss: 0 },
        );

        document.getElementById("elevation-gain").innerText = Math.round(gain);
        document.getElementById("elevation-loss").innerText = Math.round(loss);
      }

      function movingAverage(elevations, distances, maxWindowSize) {
        if (elevations.length !== distances.length + 1) {
          throw new Error("Mismatched distances and elevation count");
        }

        if (elevations.length <= 2) {
          // geometry consists only of tower nodes, there are no pillar nodes to be smoothed in between
          return elevations;
        }

        let averagedElevations = [];

        // iterate over every pillar node to smooth its elevation
        // first and last points are left out as they are tower nodes
        for (let i = 1; i <= elevations.length - 2; i++) {
          // first, determine the average window which could be smaller when close to pillar nodes
          let searchDistance = maxWindowSize / 2.0;

          let searchDistanceBack = 0.0;
          for (let j = i - 1; j >= 0; j--) {
            searchDistanceBack += distances[j];

            if (searchDistanceBack > searchDistance) {
              break;
            }
          }

          // update search distance if pillar node is close to START tower node
          searchDistance = Math.min(searchDistance, searchDistanceBack);

          let searchDistanceForward = 0.0;
          for (let j = i; j < elevations.length - 1; j++) {
            searchDistanceForward += distances[j];

            if (searchDistanceForward > searchDistance) {
              break;
            }
          }

          // update search distance if pillar node is close to END tower node
          searchDistance = Math.min(searchDistance, searchDistanceForward);

          if (searchDistance <= 0.0) {
            // there is nothing to smooth. this is an edge case where pillar nodes share exactly the same location
            // as a tower node.
            // by doing so we avoid (at least theoretically) a division by zero later in the function call
            continue;
          }

          // area under elevation curve
          let elevationArea = 0.0;

          // first going again backwards
          let distanceBack = 0.0;
          for (let j = i - 1; j >= 0; j--) {
            const dist = distances[j];
            const searchDistLeft = searchDistance - distanceBack;
            distanceBack += dist;

            if (searchDistLeft < dist) {
              // node lies outside averaging window
              const elevationDelta = elevations[j] - elevations[j + 1];
              const elevationAtSearchDistance =
                elevations[j + 1] + (searchDistLeft / dist) * elevationDelta;
              elevationArea +=
                (searchDistLeft *
                  (elevations[j + 1] + elevationAtSearchDistance)) /
                2.0;
              break;
            }

            elevationArea += (dist * (elevations[j + 1] + elevations[j])) / 2.0;
          }

          // now going forward
          let distanceForward = 0.0;
          for (let j = i; j < elevations.length - 1; j++) {
            const dist = distances[j];
            const searchDistLeft = searchDistance - distanceForward;
            distanceForward += dist;

            if (searchDistLeft < dist) {
              const elevationDelta = elevations[j + 1] - elevations[j];
              const elevationAtSearchDistance =
                elevations[j] + (searchDistLeft / dist) * elevationDelta;
              elevationArea +=
                (searchDistLeft * (elevations[j] + elevationAtSearchDistance)) /
                2.0;
              break;
            }

            elevationArea += (dist * (elevations[j + 1] + elevations[j])) / 2.0;
          }

          averagedElevations = [
            ...averagedElevations,
            Math.round((elevationArea / (searchDistance * 2)) * 100) / 100,
          ];
        }

        return [
          elevations[0],
          ...averagedElevations,
          elevations[elevations.length - 1],
        ];
      }

      function ramer(elevations, distances, maxElevationDelta) {
        let e = [...elevations];

        internSmooth(e, distances, 0, elevations.length - 1, maxElevationDelta);

        return e;
      }

      function internSmooth(
        elevations,
        distances,
        fromIndex,
        lastIndex,
        maxElevationDelta,
      ) {
        if (lastIndex - fromIndex < 2) return;

        let prevIndex = fromIndex;
        let dist2D = distances
          .slice(prevIndex, lastIndex)
          .reduce((sum, distance) => sum + distance, 0);

        // in rare cases the first point can be identical to the last for e.g. areas (or for things like man_made=pier which are not explicitly excluded from adding edges)
        let averageSlope =
          dist2D == 0
            ? 0
            : (elevations[lastIndex] - elevations[fromIndex]) / dist2D;
        let prevAverageSlopeEle = elevations[fromIndex];
        let maxEleDelta = -1;
        let indexWithMaxDelta = -1;
        for (let i = fromIndex + 1; i < lastIndex; i++) {
          let tmpDist2D = distances
            .slice(prevIndex, i)
            .reduce((sum, distance) => sum + distance, 0);
          let eleFromAverageSlope =
            averageSlope * tmpDist2D + prevAverageSlopeEle;
          let tmpEleDelta = Math.abs(elevations[i] - eleFromAverageSlope);
          if (maxEleDelta < tmpEleDelta) {
            indexWithMaxDelta = i;
            maxEleDelta = tmpEleDelta;
          }
          prevAverageSlopeEle = eleFromAverageSlope;
          prevIndex = i;
        }

        // the maximum elevation change limit filters away especially the smaller high frequent elevation changes,
        // which is likely the "noise" that we want to remove.
        if (indexWithMaxDelta < 0 || maxElevationDelta > maxEleDelta) {
          prevIndex = fromIndex;
          prevAverageSlopeEle = elevations[fromIndex];
          for (let i = fromIndex + 1; i < lastIndex; i++) {
            let tmpDist2D = distances
              .slice(prevIndex, i)
              .reduce((sum, distance) => sum + distance, 0);
            let eleFromAverageSlope =
              averageSlope * tmpDist2D + prevAverageSlopeEle;
            elevations[i] = eleFromAverageSlope;
            prevAverageSlopeEle = eleFromAverageSlope;
            prevIndex = i;
          }
        } else {
          internSmooth(
            elevations,
            distances,
            fromIndex,
            indexWithMaxDelta,
            maxElevationDelta,
          );
          internSmooth(
            elevations,
            distances,
            indexWithMaxDelta,
            lastIndex,
            maxElevationDelta,
          );
        }
      }
    </script>
  </body>
</html>
